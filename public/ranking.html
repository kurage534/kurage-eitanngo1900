<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">

  <style>
    #list div {
      background: #f4f4f4;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      font-size: 1.2rem;
    }
    #msg {
      font-size: 1.2rem;
      margin-top: 10px;
      min-height: 1.5em;
    }
    .btn {
      padding: 8px 14px;
      font-size: 1rem;
      margin-right: 6px;
    }
  </style>
</head>
<body>

<h1>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>

<!-- ç™»éŒ²ã‚¨ãƒªã‚¢ -->
<div id="register-area">
  <input id="name" placeholder="åå‰ï¼ˆå¿…é ˆï¼‰" autocomplete="off">
  <button id="send">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã™ã‚‹</button>
</div>

<div id="msg"></div>

<hr style="margin:20px 0;">

<!-- åˆ‡ã‚Šæ›¿ãˆ -->
<button class="btn" id="allBtn">å…¨ä½“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
<button class="btn" id="todayBtn">ä»Šæ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>

<h2 id="rank-title">ä¸Šä½10ä½ï¼ˆå…¨ä½“ï¼‰</h2>
<div id="list">èª­ã¿è¾¼ã¿ä¸­...</div>

<br>
<a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>

<script>
function esc(s) {
  return s.replace(/[&<>"']/g, c => ({
    '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
  }[c]));
}

// ----------------------------
// ç™»éŒ²å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
// ----------------------------
const canRegister = localStorage.getItem("CAN_REGISTER");
const registerArea = document.getElementById("register-area");
const msg = document.getElementById("msg");

if (canRegister !== "YES") {
  registerArea.style.display = "none";
  msg.textContent = "â€» ã‚¯ã‚¤ã‚ºã‚’1å›ã‚¯ãƒªã‚¢ã—ãŸæ™‚ã ã‘ç™»éŒ²ã§ãã¾ã™";
  msg.style.color = "red";
}

// ----------------------------
// ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿å…±é€š
// ----------------------------
async function loadRanking(url, title) {
  document.getElementById("rank-title").textContent = title;
  document.getElementById("list").textContent = "èª­ã¿è¾¼ã¿ä¸­...";

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      document.getElementById("list").innerHTML =
        "<div>ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>";
      return;
    }

    document.getElementById("list").innerHTML =
      data.map((x, i) => `
        <div>
          <strong>${i + 1}ä½</strong><br>
          åå‰ï¼š${esc(x.name)}<br>
          ã‚¹ã‚³ã‚¢ï¼š${x.score} ç‚¹<br>
          ã‚¿ã‚¤ãƒ ï¼š${x.time} ç§’
        </div>
      `).join("");

  } catch {
    document.getElementById("list").innerHTML =
      "<div style='color:red;'>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>";
  }
}

// åˆæœŸè¡¨ç¤º
loadRanking("/api/ranking", "ä¸Šä½10ä½ï¼ˆå…¨ä½“ï¼‰");

// åˆ‡ã‚Šæ›¿ãˆ
document.getElementById("allBtn").onclick = () =>
  loadRanking("/api/ranking", "ä¸Šä½10ä½ï¼ˆå…¨ä½“ï¼‰");

document.getElementById("todayBtn").onclick = () =>
  loadRanking("/api/ranking/today", "ä¸Šä½10ä½ï¼ˆä»Šæ—¥ï¼‰");

// ----------------------------
// ãƒ©ãƒ³ã‚­ãƒ³ã‚°é€ä¿¡
// ----------------------------
document.getElementById("send").addEventListener("click", async () => {
  const name = document.getElementById("name").value.trim();
  const score = Number(localStorage.getItem("score"));
  const time = Number(localStorage.getItem("time"));

  msg.textContent = "";

  if (!name) {
    msg.textContent = "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    msg.style.color = "red";
    return;
  }

  try {
    const res = await fetch("/api/submit", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ name, score, time })
    });

    const result = await res.json();

    if (result.result === "not_best") {
      msg.textContent = "è‡ªå·±ãƒ™ã‚¹ãƒˆã§ã¯ãªã„ãŸã‚ç™»éŒ²ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ";
      msg.style.color = "orange";
      return;
    }

    if (result.result === "updated") {
      msg.textContent = "ğŸ‰ è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°ï¼";
      msg.style.color = "green";
    }

    if (result.result === "ok") {
      msg.textContent = "ç™»éŒ²ã—ã¾ã—ãŸï¼";
      msg.style.color = "green";
    }

    // äºŒé‡ç™»éŒ²é˜²æ­¢
    localStorage.setItem("CAN_REGISTER", "NO");
    registerArea.style.display = "none";

    loadRanking("/api/ranking", "ä¸Šä½10ä½ï¼ˆå…¨ä½“ï¼‰");

  } catch {
    msg.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼šç™»éŒ²ã§ãã¾ã›ã‚“ã§ã—ãŸ";
    msg.style.color = "red";
  }
});
</script>

</body>
</html>
