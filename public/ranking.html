<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>

<!-- è‡ªåˆ†ã®é †ä½ -->
<div id="my-rank" style="display:none; margin-bottom:15px;"></div>

<!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ² -->
<div id="register-area" style="display:none; margin-bottom:20px;">
  <input id="player-name" placeholder="åå‰ã‚’å…¥åŠ›">
  <button id="register-btn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</button>
  <div id="register-msg"></div>
</div>

<ul id="ranking-list">
  <li>èª­ã¿è¾¼ã¿ä¸­...</li>
</ul>

<!-- ã“ã“ã« Google ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ  -->
<div id="feedback-area" style="margin-top:20px;">
  <p>ã”æ„è¦‹ãƒ»ä¸å…·åˆå ±å‘Šã¯ã“ã¡ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠé¡˜ã„ã—ã¾ã™ï¼š</p>
  <p>
    <a id="google-form-link" href="https://docs.google.com/forms/d/e/1FAIpQLSfNTE5LrQXNPu_qzcGhbpjR7weBP-Zn5YmE10Ixr2x5DzUcqw/viewform"
      target="_blank" rel="noopener noreferrer">Googleãƒ•ã‚©ãƒ¼ãƒ ã§é€ã‚‹
    </a>
  </p>
</div>

<a href="game.html">â† ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹</a>

<script>
/* ===============================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
=============================== */
async function loadRanking() {
  const list = document.getElementById("ranking-list");
  list.innerHTML = "<li>èª­ã¿è¾¼ã¿ä¸­...</li>";

  try {
    const res = await fetch("/api/ranking");
    const data = await res.json();

    list.innerHTML = "";
    if (!data.length) {
      list.innerHTML = "<li>ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</li>";
      return;
    }

    data.forEach((r, i) => {
      const li = document.createElement("li");
      li.textContent = `${i + 1}ä½ ${r.name} ${r.score}ç‚¹ ${r.time ?? "-"}ç§’`;
      list.appendChild(li);
    });
  } catch {
    list.innerHTML = "<li>å–å¾—å¤±æ•—</li>";
  }
}

/* ===============================
   è‡ªåˆ†ã®é †ä½
=============================== */
async function loadMyRank() {
  const name = localStorage.getItem("playerName");
  const score = localStorage.getItem("score");
  const time = localStorage.getItem("time");
  if (!name || !score) return;

  const res = await fetch(
    `/api/my-rank?name=${encodeURIComponent(name)}&score=${score}&time=${time}`
  );
  const data = await res.json();

  const box = document.getElementById("my-rank");
  box.style.display = "block";
  box.textContent = `ğŸ‰ ã‚ãªãŸã®é †ä½ï¼š${data.rank} ä½`;
}

/* ===============================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²
=============================== */
if (localStorage.getItem("CAN_REGISTER") === "YES") {
  document.getElementById("register-area").style.display = "block";
}

document.getElementById("register-btn").onclick = async () => {
  const name = document.getElementById("player-name").value.trim();
  const score = Number(localStorage.getItem("score"));
  const time = Number(localStorage.getItem("time"));

  if (!name) {
    document.getElementById("register-msg").textContent = "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  const res = await fetch("/api/submit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, score, time })
  });

  const data = await res.json();
  if (data.result === "ok") {
    localStorage.setItem("playerName", name);
    localStorage.removeItem("CAN_REGISTER");
    document.getElementById("register-area").style.display = "none";
    loadRanking();
    loadMyRank();
  } else {
    document.getElementById("register-msg").textContent = "ç™»éŒ²å¤±æ•—";
  }
};
/* ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‹•ä½œ */
document.getElementById('to-index').addEventListener('click', () => {
  window.location.href = 'index.html';
});


loadRanking();
loadMyRank();
</script>

</body>
</html>
