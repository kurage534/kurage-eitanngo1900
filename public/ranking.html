<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>

<!-- è‡ªåˆ†ã®é †ä½ -->
<div id="my-rank" style="display:none; margin-bottom:15px;"></div>

<!-- â–¼â–¼â–¼ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆè¿½åŠ ï¼‰ â–¼â–¼â–¼ -->
<div id="register-area" style="display:none; margin-bottom:20px;">
  <input id="player-name" placeholder="åå‰ã‚’å…¥åŠ›">
  <button id="register-btn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</button>
  <div id="register-msg" style="margin-top:10px;"></div>
</div>

<ul id="ranking-list" style="list-style:none; padding:0;">
  <li>èª­ã¿è¾¼ã¿ä¸­...</li>
</ul>

<a href="game.html">â† ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹</a>

<script>
/* ===============================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
=============================== */
async function loadRanking() {
  const list = document.getElementById("ranking-list");
  list.innerHTML = "<li>èª­ã¿è¾¼ã¿ä¸­...</li>";

  try {
    const res = await fetch("/api/ranking");
    const data = await res.json();

    list.innerHTML = "";

    if (!data.length) {
      list.innerHTML = "<li>ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</li>";
      return;
    }

    data.forEach((r, i) => {
      const li = document.createElement("li");
      li.style.background = "#f1f1f1";
      li.style.margin = "8px 0";
      li.style.padding = "12px";
      li.style.borderRadius = "10px";

      li.textContent =
        `${i + 1}ä½ã€€${r.name}ã€€${r.score}ç‚¹ã€€${r.time ?? "-"}ç§’`;

      list.appendChild(li);
    });
  } catch {
    list.innerHTML = "<li>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</li>";
  }
}

/* ===============================
   è‡ªåˆ†ã®é †ä½
=============================== */
async function loadMyRank() {
  const name = localStorage.getItem("playerName");
  const score = localStorage.getItem("score");
  const time = localStorage.getItem("time");

  if (!name || !score) return;

  try {
    const res = await fetch(
      `/api/my-rank?name=${encodeURIComponent(name)}&score=${score}&time=${time}`
    );
    const data = await res.json();

    const box = document.getElementById("my-rank");
    box.style.display = "block";
    box.style.background = "#e8f3ff";
    box.style.padding = "12px";
    box.style.borderRadius = "12px";
    box.style.textAlign = "center";
    box.style.fontSize = "1.2rem";

    box.textContent = `ğŸ‰ ã‚ãªãŸã®é †ä½ï¼š${data.rank} ä½`;
  } catch {}
}

/* ===============================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²
=============================== */
const canRegister = localStorage.getItem("CAN_REGISTER");
if (canRegister === "YES") {
  document.getElementById("register-area").style.display = "block";
}

document.getElementById("register-btn").onclick = async () => {
  const name = document.getElementById("player-name").value.trim();
  const score = Number(localStorage.getItem("score"));
  const time = Number(localStorage.getItem("time"));

  if (!name) {
    document.getElementById("register-msg").textContent = "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  try {
    const res = await fetch("/api/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, score, time })
    });

    const data = await res.json();

    if (data.result === "ok") {
      document.getElementById("register-msg").textContent = "ç™»éŒ²ã—ã¾ã—ãŸï¼";
      localStorage.setItem("playerName", name);
      localStorage.removeItem("CAN_REGISTER");
      loadRanking();
      loadMyRank();
    } else {
      document.getElementById("register-msg").textContent = "ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™";
    }
  } catch {
    document.getElementById("register-msg").textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
  }
};

loadRanking();
loadMyRank();
</script>

</body>
</html>
