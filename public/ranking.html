<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<h1>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>

<!-- ç™»éŒ²ã‚¨ãƒªã‚¢ -->
<div id="register-area">
  <input id="name" placeholder="åå‰ï¼ˆå¿…é ˆï¼‰" autocomplete="off">

  <!-- â˜… ã“ã“ã«è¿½åŠ  -->
  <input type="hidden" id="mode">

  <button id="send">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã™ã‚‹</button>
</div>


<div id="msg"></div>

<!-- â˜… è‡ªåˆ†ã®é †ä½ -->
<div id="my-rank" style="margin:20px 0;font-size:1.2rem;"></div>

<hr>

<h2>ä¸Šä½10ä½</h2>
<div id="list">èª­ã¿è¾¼ã¿ä¸­...</div>

<br>
<a href="index.html">â† ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const mode = localStorage.getItem("mode");
  document.getElementById("mode").value = mode;
});
</script>

<script>
function esc(s) {
  return s.replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

const CAN = localStorage.getItem("CAN_REGISTER");
const registerArea = document.getElementById("register-area");
const msg = document.getElementById("msg");

if (CAN !== "YES") {
  registerArea.style.display = "none";
  msg.textContent = "â€» ã‚¯ã‚¤ã‚ºã‚’1å›ã‚¯ãƒªã‚¢ã—ãŸæ™‚ã ã‘ç™»éŒ²ã§ãã¾ã™";
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿
async function loadRanking() {
  const res = await fetch("/api/ranking");
  const data = await res.json();

  if (!Array.isArray(data)) {
    document.getElementById("list").textContent = "èª­ã¿è¾¼ã¿å¤±æ•—";
    return;
  }

  // ä¸Šä½10
  document.getElementById("list").innerHTML =
    data.slice(0,10).map((x,i)=>`
      <div>
        <b>${i+1}ä½</b><br>
        ${esc(x.name)} / ${x.score}ç‚¹ / ${x.time ?? "-"}ç§’
      </div>
    `).join("");

  // â˜… è‡ªåˆ†ã®é †ä½è¨ˆç®—
  const myName = localStorage.getItem("LAST_NAME");
  const myScore = Number(localStorage.getItem("score"));
  const myTime = Number(localStorage.getItem("time"));

  const idx = data.findIndex(x =>
    x.name === myName &&
    x.score === myScore &&
    Number(x.time) === myTime
  );

  if (idx >= 0) {
    document.getElementById("my-rank").textContent =
      `ğŸ‰ ã‚ãªãŸã®é †ä½ï¼š${idx + 1}ä½`;
  }
}
loadRanking();

// ç™»éŒ²
document.getElementById("send").onclick = async () => {
  const name = document.getElementById("name").value.trim();
  const score = Number(localStorage.getItem("score"));
  const time = Number(localStorage.getItem("time"));

  if (!name) {
    msg.textContent = "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  const res = await fetch("/api/submit", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    const mode = document.getElementById("mode").value;

    body: JSON.stringify({ name, score, time, mode })

  });

  const r = await res.json();

  if (r.result === "ok") {
    msg.textContent = "ç™»éŒ²ã—ã¾ã—ãŸï¼";
    localStorage.setItem("CAN_REGISTER","NO");
    localStorage.setItem("LAST_NAME", name);
    registerArea.style.display = "none";
    loadRanking();
  } else if (r.result === "duplicate") {
    msg.textContent = "åŒã˜è¨˜éŒ²ã¯ç™»éŒ²æ¸ˆã¿ã§ã™";
  } else {
    msg.textContent = "ç™»éŒ²å¤±æ•—";
  }
};
</script>

  <!-- ç®¡ç†è€…ãƒªãƒ³ã‚¯ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ã¿è¡¨ç¤ºï¼‰ -->
<div id="admin-link" style="display:none; text-align:center; margin-top:25px;">
  <a href="admin.html" style="font-size:1.1rem;">ğŸ”’ ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã¸</a>
</div>

<script>
  if (sessionStorage.getItem("ADMIN_LOGIN") === "YES") {
    document.getElementById("admin-link").style.display = "block";
  }
</script>


</body>
</html>


