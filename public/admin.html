<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†è€…ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>ğŸ”’ ç®¡ç†è€…ç”»é¢</h1>

<!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ -->
<div id="login-area">
  <input id="admin-pass" type="password" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <div id="login-msg"></div>
</div>

<!-- ç®¡ç†ç”»é¢ -->
<div id="admin-area" style="display:none;">
  <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§</h2>

  <!-- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
<button id="export-csv-btn" style="margin-bottom:15px;">
  ğŸ“¥ ãƒ©ãƒ³ã‚­ãƒ³ã‚°CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
</button>

  <ul id="admin-ranking" style="list-style:none; padding:0;"></ul>
</div>

<script>
let adminPass = "";

/* ===============================
   ãƒ­ã‚°ã‚¤ãƒ³
=============================== */
document.getElementById("login-btn").onclick = async () => {
  const pass = document.getElementById("admin-pass").value;
  if (!pass) return;

  const res = await fetch("/api/admin/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ pass })
  });

  if (res.ok) {
    adminPass = pass;
    document.getElementById("login-area").style.display = "none";
    document.getElementById("admin-area").style.display = "block";
    loadAdminRanking();
  } else {
    document.getElementById("login-msg").textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
  }
};

/* ===============================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
=============================== */
async function loadAdminRanking() {
  const list = document.getElementById("admin-ranking");
  list.innerHTML = "<li>èª­ã¿è¾¼ã¿ä¸­...</li>";

  const res = await fetch("/api/ranking");
  const data = await res.json();

  list.innerHTML = "";

  data.forEach(r => {
    const li = document.createElement("li");
    li.style.background = "#f1f1f1";
    li.style.margin = "8px 0";
    li.style.padding = "12px";
    li.style.borderRadius = "10px";

    li.innerHTML = `
      ${r.name} / ${r.score}ç‚¹ / ${r.time ?? "-"}ç§’
      <button style="margin-top:8px; background:#e74c3c;"
        onclick="deleteEntry('${r.name}', ${r.score})">
        å‰Šé™¤
      </button>
    `;

    list.appendChild(li);
  });
}

/* ===============================
   å‰Šé™¤
=============================== */
async function deleteEntry(name, score) {
  if (!confirm(`${name} (${score}ç‚¹) ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  const res = await fetch("/api/admin/delete-entry", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      pass: adminPass,
      name,
      score
    })
  });

  const data = await res.json();

  if (data.result === "deleted") {
    alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    loadAdminRanking();
  } else {
    alert("å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ");
  }
}
/* ===============================
   CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
=============================== */
document.getElementById("export-csv-btn").onclick = () => {
  if (!adminPass) {
    alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
    return;
  }

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹
  window.location.href =
    `/api/admin/export/ranking?pass=${encodeURIComponent(adminPass)}`;
};

</script>

</body>
</html>


